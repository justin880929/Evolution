<div class="container-xxl flex-grow-1 container-p-y">
  <!-- 步驟條 -->
  <div class="card mb-md-3 p-md-3">
    <p-steps [model]="steps" [activeIndex]="currentStep" [readonly]="true" class="mb-4"></p-steps>
  </div>

  <!-- 表單內容卡片 -->
  <div class="card p-4">
    <!-- Step: 建立課程 -->
    <form *ngIf="steps[currentStep]?.label === '建立課程'" [formGroup]="courseDetailForm">
      <div class="mb-3">
        <label class="form-label">課程標題</label>
        <input type="text" class="form-control" formControlName="courseTitle" />
      </div>

      <div class="mb-3">
        <label class="form-label">課程描述</label>
        <textarea class="form-control" formControlName="courseDes"></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label d-block">是否公開</label>
        <div class="form-check form-check-inline">
          <p-radioButton name="isPublic" value="true" inputId="public-yes" formControlName="isPublic"></p-radioButton>
          <label for="public-yes" class="form-check-label ms-1">是</label>
        </div>
        <div class="form-check form-check-inline">
          <p-radioButton name="isPublic" value="false" inputId="public-no" formControlName="isPublic"></p-radioButton>
          <label for="public-no" class="form-check-label ms-1">否</label>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">課程價格</label>
        <input type="number" class="form-control" formControlName="coursePrice" />
      </div>

      <div class="mb-3">
        <label class="form-label">課程封面</label>
        <input type="file" class="form-control" (change)="onCoverSelected($event)" />
        <img [src]="coverPreviewUrl" class="img-thumbnail mt-2" style="max-width: 300px;" *ngIf="coverPreviewUrl" />
      </div>
    </form>

    <!-- Step: 新增章節 -->
    <form *ngIf="steps[currentStep]?.label === '新增章節'" [formGroup]="chapterForm">
      <div class="mb-3">
        <label class="form-label">章節標題</label>
        <input type="text" class="form-control" formControlName="chapterTitle" />
      </div>

      <div class="mb-3">
        <label class="form-label">章節描述</label>
        <textarea class="form-control" formControlName="chapterDes"></textarea>
      </div>
    </form>

    <!-- Step: 新增影片 -->
    <form *ngIf="steps[currentStep]?.label === '新增影片'" [formGroup]="videoForm">
      <div class="mb-3">
        <label class="form-label">影片標題</label>
        <input type="text" class="form-control" formControlName="title" />
      </div>

      <div class="mb-3">
        <label class="form-label">上傳影片</label>
        <input type="file" class="form-control" (change)="onVideoSelected($event)" #videofile />
        <div *ngIf="selectedVideoFileName" class="mt-1 text-muted">
          已選擇：{{ selectedVideoFileName }}
        </div>
      </div>
    </form>
  </div>

  <!-- 按鈕控制區 -->
  <div class="mt-4 d-flex justify-content-between">
    <!-- 上一步 -->
    <div>
      <ng-container *ngIf="currentStep > 0 && !isFormDirty(); else showSaveReminder">
        <button class="btn btn-secondary" (click)="onPrev()">上一步</button>
      </ng-container>
      <ng-template #showSaveReminder>
        <span *ngIf="currentStep > 0" class="text-warning">
          <i class="pi pi-exclamation-triangle me-1"></i>請先儲存再返回上一步</span>
      </ng-template>
    </div>
    <div class="d-flex gap-2">
      <button *ngIf="shouldShowEditButton()" class="btn btn-warning" (click)="onEdit()">
        儲存資料修改
      </button>
      <button *ngIf="currentStep>1&&(currentStep===steps.length-1)&&!isFinalStep" class="btn btn-danger"
        (click)="removeLastStep()">
        刪除此步驟
      </button>
      <button
        *ngIf="!isFormDirty() && (currentStep < steps.length - 1 || lastUnsavedChapter || lastUnsavedVideo || currentStep === 0 || getHasFinal())"
        class="btn btn-primary" (click)="onNext()">
        下一步
      </button>

      <!-- 只有在最後一步，且沒有要回填資料，才顯示 addNewSteps -->
      <button *ngIf="currentStep === steps.length - 1 && !isFinalStep && !lastUnsavedChapter && !lastUnsavedVideo"
        class="btn btn-primary" (click)="addNewSteps()">
        下一步
      </button>

      <button *ngIf="isFinalStep&&(currentStep===steps.length-1)" class="btn btn-success" (click)="finalizeCourse()">
        確認建立
      </button>
      <button class="btn btn-success" (click)="finalizeCourse()">
        檢查
      </button>
    </div>
  </div>

  <!-- PrimeNG ConfirmDialog & Toast -->
  <p-confirmDialog></p-confirmDialog>
  <p-toast></p-toast>
</div>